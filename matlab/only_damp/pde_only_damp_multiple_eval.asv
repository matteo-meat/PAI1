baseInputFolder  = 'predictions_csv_files';
baseOutputFolder = 'matlab_simulations'; 
modelTypes = {'MLP', 'KAN', 'RWF'};
numInstances = 6; 

% Create the base output folder if it doesn't exist.
if ~exist(baseOutputFolder, 'dir')
    mkdir(baseOutputFolder);
end

%% --- Loop Over Each Model Folder ---
for m = 1:length(modelTypes)
    modelType = modelTypes{m};
    for n = 1:numInstances
        
        % Construct folder name (e.g., 'MLP_1') and determine input/output folders.
        folderName = sprintf('%s_%d', modelType, n);
        inputFolder = fullfile(baseInputFolder, folderName);
        
        if ~exist(inputFolder, 'dir')
            fprintf('Input folder %s not found. Skipping...\n', inputFolder);
            continue;
        end
        
        predictionsFile = fullfile(inputFolder, 'predictions.csv');
        if ~exist(predictionsFile, 'file')
            fprintf('File predictions.csv not found in folder %s. Skipping...\n', inputFolder);
            continue;
        end
        
        outputFolder = fullfile(baseOutputFolder, folderName);
        if ~exist(outputFolder, 'dir')
            mkdir(outputFolder);
        end
        
        fprintf('Processing folder: %s\n', folderName);
        
        %% --- Load and Save Prediction Data ---
        csv = readtable(predictionsFile);
        u = csv{:,:};
        save(fullfile(outputFolder, 'formatted_predictions.mat'), 'u');
        
        %% --- Generate Time Vector ---
        % Here we assume that the time vector should have as many entries as there are columns in u.
        % Modify the range [0, 1] if a different final time is desired.
        tlist = linspace(0, 1, size(u,2));
        
        %% --- Compute Simulation Metrics ---
        % Calculate the maximum displacement at each time step
        maxDisplacement = max(abs(u), [], 1);
        
        % Calculate the L2 norm of the displacement at each time step
        l2Norm = sqrt(sum(u.^2, 1));
        
        %% --- Plot Maximum Displacement Over Time ---
        figure;
        plot(tlist, maxDisplacement, 'r', 'LineWidth', 2);
        xlabel('Time (s)');
        ylabel('Maximum Displacement');
        title('Maximum Displacement Over Time');
        grid on;
        savefig(fullfile(outputFolder, 'displ_damp.fig'));
        close(gcf);  % Close the figure to avoid clutter
        
        %% --- Plot L2 Norm Over Time ---
        figure;
        plot(tlist, l2Norm, 'b', 'LineWidth', 2);
        xlabel('Time (s)');
        ylabel('L2 Norm of Displacement');
        title('L2 Norm of Displacement Over Time');
        grid on;
        savefig(fullfile(outputFolder, 'l2_damp.fig'));
        close(gcf);
        
        fprintf('Finished processing folder: %s\n', folderName);
    end
end

fprintf('All predictions have been processed.\n');
